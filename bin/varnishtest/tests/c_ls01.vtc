varnishtest "New ban-lurker test"

server s1 {
	rxreq
	expect req.url == /1
	txresp -hdr "Foo: bar1"

} -start

varnish v1 -vcl+backend {} -start

varnish v1 -cliok "param.set ban_lurker_age 0"
varnish v1 -cliok "param.set ban_lurker_sleep 0"
varnish v1 -cliok "param.set ban_cleaner_sleep 0"
varnish v1 -cliok "param.set debug +lurker"
varnish v1 -cliok "param.set debug +syncvsl"

client c1 {
	txreq -url /1
	rxresp
	expect resp.http.foo == bar1
} -run

varnish v1 -cliok "ban obj.http.foo == bar1"
varnish v1 -cliok "ban req.url == /test"
varnish v1 -cliok "ban req.url == /test"
varnish v1 -cliok "ban.list"

varnish v1 -expect n_object == 1
varnish v1 -expect bans == 4
varnish v1 -expect bans_dups == 1
varnish v1 -expect bans_completed == 2

varnish v1 -cliok "param.set ban_cleaner_sleep .01"

varnish v1 -cliok "ban.list"

varnish v1 -expect n_object == 1
varnish v1 -expect bans == 3
varnish v1 -expect bans_dups == 1
varnish v1 -expect bans_completed == 1
